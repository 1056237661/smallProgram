<template lang='pug'>
  repeat( for="{{ listData }}" key="index" index="index" item="item")
    new_list( :dataobj="item" )
  noData( wx:if="{{ listData.length == 0 }}" :text='noDataText' )
</template>

<style>

</style>

<script>
import wepy from "wepy";
import wxRequest from '@/utils/wxRequest'
import tip from '@/utils/tip'

import new_list from '@/components/news_list'
import noData from '@/components/noData'
import wx_req from '@/utils/wxRequest/wx_req'

export default class MessageList extends wepy.page {
  config = {
    navigationBarTitleText: 'æ”¶åˆ°çš„æ¶ˆæ¯',
  }

  components = {
    new_list: new_list,
    noData: noData
  }
  
  data = {
    noDataText: '',
    icon60: '../../images/user1.png',
    page:{
      PageNo: '1',
      PageSize: '10'
    },
    listData:[],
    total: 0
  }

  onShow(){
    this.getList();
  }

  onLoad(){
    // wx_req.showShareMenu();  // æ˜¾ç¤ºè½¬å‘
  }

  // è·å–ä¿¡æ¯
  async getList(){
    // tip.loading();
    this.listData =  [];
    this.page.PageNo = 1;
    let listData = await wxRequest.Get('/mydb/Get_UserMassage', this.page);
    this.listData = listData.list || [];
    this.total = listData.total || 0
    !this.listData.length && (this.noDataText = 'ä¸–ç•Œè¾£ä¹ˆå¤§ï¼Œå’±å°±æ²¡äººè”ç³»æˆ‘ğŸ˜¡');
    wx.removeTabBarBadge({index: 0})  // æ¸…é™¤å¾½ç« 
    this.$apply();
  }

  // ä¸‹æ‹‰åˆ·æ–°
  async onPullDownRefresh(){
    let flag = await this.getList();
    wx.stopPullDownRefresh({
        success(){ console.log('ä¸‹æ‹‰åˆ·æ–° success') }
        ,fail(){ console.log('ä¸‹æ‹‰åˆ·æ–° fail') }
        ,complete(){ console.log('ä¸‹æ‹‰åˆ·æ–° complete') }
    });
  }

  // ä¸Šæ‹‰åŠ è½½
  async onReachBottom (){
    tip.loading('ç©å‘½åŠ è½½ä¸­');
    const PageNo = this.total/this.page.PageSize;
    if( PageNo > this.page.PageNo ){
      this.page.PageNo++
      const data = await wxRequest.Get('/mydb/Get_UserMassage',this.page);
      this.total = data.total;
      this.listData.push(...data.list);
      this.$apply()
      tip.loaded();
    }else{
      tip.toast("åšäººä¸èƒ½æ²¡æœ‰åº•çº¿", 'none')
    }
  }
}
</script>




